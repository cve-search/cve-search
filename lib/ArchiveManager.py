from gzip import GzipFile
from zipfile import ZipFile
from tarfile import TarFile
import os

from lib.ExtensionSignature import ExtensionSignature


class ArchiveManager:
    MAGIC_BYTES = ExtensionSignature.maxSize()

    @classmethod
    def extract(cls, archive, **kwargs) -> list:
        """
        Extracts the given archive.
        :param archive: The path for the archive to extract.
        :param kwargs:
            target (str): Target dir where to extract the archive.
        :return: The list of paths for the extracted files.
        """
        targetDir = os.path.dirname(archive)
        fileName = os.path.splitext(os.path.basename(archive))[0]
        targetFilePath = os.path.join(targetDir, fileName)

        if kwargs.get("target"):
            targetDir = kwargs.get("target")

        chunkSize = 1024
        if kwargs.get("chunkSize"):
            chunkSize = kwargs.get("chunkSize")

        with open(archive, "rb") as f:
            signature = f.read(ArchiveManager.MAGIC_BYTES)
            extension = ExtensionSignature.fromSignature(signature.hex())

        if ExtensionSignature.ZIP is extension:
            with ZipFile(archive) as f:
                items = f.namelist()

                f.extractall(path=targetDir)

            return [os.path.join(targetDir, item) for item in items]
        elif ExtensionSignature.GZip is extension:
            with GzipFile(archive, "rb") as f:
                with open(targetFilePath, "wb") as output:
                    while True:
                        chunk = f.read(chunkSize)
                        if chunk:
                            output.write(chunk)
                        else:
                            break

            return [targetFilePath]
