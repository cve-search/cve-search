#!/usr/bin/env python3
#
# Updater script of CVE/CPE database
#
# Software is free software released under the "GNU Affero General Public License v3.0"
#
# Copyright (c) 2012-2019  Alexandre Dulaunoy - a@foo.be
# Copyright (c) 2014-2018  Pieter-Jan Moreels - pieterjan.moreels@gmail.com
# Imports
import argparse
import logging
import os
import shlex
import subprocess
import sys
import time

from CveXplore import CveXplore

runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

from lib.LogHandler import UpdateHandler
from lib.Sources_process import (
    CPERedisBrowser,
)
from lib.Config import Configuration
from lib.DatabaseLayer import getSize, dropCollection, getTableNames

logging.setLoggerClass(UpdateHandler)

logger = logging.getLogger("DBUpdater")

sources = [
    {
        "name": "cpeother",
        "updater": "{} {}".format(
            sys.executable, os.path.join(runPath, "db_mgmt_cpe_other_dictionary.py")
        ),
    },
]

argParser = argparse.ArgumentParser(description="Database updater for cve-search")
argParser.add_argument("-v", action="store_true", help="Logging on stdout")
argParser.add_argument(
    "-l", action="store_true", help="Running at regular interval", default=False
)
argParser.add_argument(
    "-i",
    action="store_true",
    help="Indexing new cves entries in the fulltext indexer",
    default=False,
)
argParser.add_argument(
    "-c", action="store_true", help="Enable CPE redis cache", default=False
)
argParser.add_argument(
    "-f",
    action="store_true",
    help="Drop collections and force initial import",
    default=False,
)
argParser.add_argument("-m", action="store_true", help="Minimal import", default=False)

args = argParser.parse_args()

if not args.m:
    sources.extend(
        [
            {"name": "redis-cache-cpe", "updater": CPERedisBrowser},
        ]
    )

if args.f and args.l:
    logger.info("Drop collections and running in loop should not be used.")
    argParser.print_help()
    sys.exit(2)


def nbelement(collection=None):
    if collection is None or collection == "cve":
        collection = "cves"
    return getSize(collection)


def dropcollection(collection=None):
    if collection is None:
        return False
    if collection == "cve":
        collection = "cves"
    ret = dropCollection(collection)
    return ret


loop = True

if args.f:
    logger.info("Dropping metadata")
    to_drop = ["cpeother", "mgmt_whitelist", "mgmt_blacklist", "info", "schema"]
    for each in to_drop:
        dropcollection(each)

while loop:
    if args.v:
        logger.info("==========================")
        logger.info(time.strftime("%a %d %B %Y %H:%M", time.gmtime()))
        logger.info("==========================")
    if not args.l:
        loop = False

    if args.c or args.v or len(sys.argv) == 1:
        cvex = CveXplore()
        cvex.database.update()

    if args.f:
        cvex = CveXplore()
        cvex.database.initialize()

    newelement = 0
    for source in sources:
        if (
            not Configuration.includesFeed(source["name"])
            and source["name"] != "redis-cache-cpe"
        ):
            continue
        if args.f and source["name"] != "redis-cache-cpe":
            logger.info("Dropping collection: " + source["name"])
            dropcollection(collection=source["name"])
            logger.info(source["name"] + " dropped")
        if source["name"] == "cpeother":
            if "cpeother" not in getTableNames():
                continue
        if source["name"] != "redis-cache-cpe":
            logger.info("Starting " + source["name"])
            before = nbelement(collection=source["name"])

            if isinstance(source["updater"], str):
                subprocess.Popen((shlex.split(source["updater"]))).wait()
            else:
                up = source["updater"]()
                up.update()

            after = nbelement(collection=source["name"])
            message = (
                source["name"]
                + " has "
                + str(after)
                + " elements ("
                + str(after - before)
                + " update)"
            )
            newelement = str(after - before)
            logger.info(message)
        elif args.c is True and source["name"] == "redis-cache-cpe":
            logger.info("Starting " + source["name"])
            up = source["updater"]()
            up.update()
            logger.info(source["name"] + " updated")

    if args.i and int(newelement) > 0:
        subprocess.Popen(
            (
                shlex.split(
                    "{} {} {}".format(
                        sys.executable,
                        os.path.join(runPath, "db_fulltext.py"),
                        "-v -l " + newelement,
                    )
                )
            )
        ).wait()
    if args.l is not False:
        logger.info("Sleeping...")
        time.sleep(3600)
