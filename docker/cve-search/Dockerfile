# Use the latest Python image
# hadolint ignore=DL3007
FROM python:latest

# Set an environment variable with the directory
# where we'll be running the app
ENV APP /app
ENV PYTHONUNBUFFERED 1
ENV WORKER_SIZE 1

ARG REDIS_HOST
ARG MONGO_HOST


# Create the directory and instruct Docker to operate
# from there from now on
RUN mkdir $APP
WORKDIR $APP

COPY  ./src/ ./

# Install the dependencies
# hadolint ignore=SC2002,DL4006
RUN pip install --no-cache-dir -r requirements.txt && \
    cat /app/configuration.ini.tmpl | sed 's,REDIS_HOST_PLACEHOLDER,'"$REDIS_HOST"',' | sed 's,MONGO_HOST_PLACEHOLDER,'"$MONGO_HOST"',' >> /etc/configuration.ini

EXPOSE 5000

# run the command to start the webserver
CMD ["python", "./web/index.py"]