from flask import redirect
import os
from ..run import oidc
from . import auth

@auth.route("/logout")
@oidc.require_login
def logout():
    info = oidc.user_getinfo(["preferred_username", "email", "sub"])
    from oauth2client.client import OAuth2Credentials
    id_token = OAuth2Credentials.from_json(oidc.credentials_store[info.get("sub")]).token_response["id_token"]
    logout_request = "{ad_logout_url}?id_token_hint={id_token}&post_logout_redirect_uri={post_logout_redirect_uri}".format(id_token=id_token, post_logout_redirect_uri=os.environ.get('POST_LOGOUT_REDIRECT_URI'),ad_logout_url=os.environ.get('AD_LOGOUT_URL'))
    oidc.logout()
    return redirect(logout_request)
