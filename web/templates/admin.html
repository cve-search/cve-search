{% extends 'layouts/master-page' %}
{% block title %}Admin page{% endblock %}
{% block head %}
  <!-- css -->
  <link href="/static/css/custom/admin.css" rel="stylesheet" />

  <!-- javascript -->
  <script type="text/javascript" src="/static/js/custom/admin.js"></script>
{% endblock %}
{% block content %}
  <!-- Status -->
  <div>
    <!-- type -->
    {% if status[1] == 'success' %}
      <div class="alert alert-success">
        <span class="glyphicon glyphicon-ok-sign"></span>
    {% elif status[1] == 'info' %}
      <div class="alert alert-info">
        <span class="glyphicon glyphicon-info-sign"></span>
    {% elif status[1] == 'warning' %}
      <div class="alert alert-warning">
        <span class="glyphicon glyphicon-warning-sign"></span>
    {% elif status[1] == 'error' %}
      <div class="alert alert-danger">
        <span class="glyphicon glyphicon-remove-sign"></span>
    {% else %}
      <div>
    {% endif %}
      <!-- content -->
      {% if status[0].startswith('wl_') %}
          {% set list = 'Whitelist' %}
      {% elif status[0].startswith('bl_') %}
          {% set list = 'Blacklist' %}
      {% endif %}

      {% if status[0] == 'logged_in' %}
        Logged in succesfully
      {% elif status[0] == 'default' %}
        {% if updateOutput %}
          Last update info
          <div class=well"><pre>{{updateOutput}}</pre></div>
        {% endif %}
      {% elif status[0] == 'db_updated' %}
        Database update finished
        <div class=well"><pre>{{updateOutput}}</pre></div>
      {% elif (status[0] == 'wl_imported') or (status[0] == 'bl_imported') %}
        {{ list }} import finished
      {% elif (status[0] == 'wl_already_filled') or (status[0] == 'bl_already_filled') %}
        {{ list }} is already filled. You can force to drop the database
      {% elif (status[0] == 'wl_exported') or (status[0] == 'bl_exported') %}
        {{ list }} export finished
      {% elif (status[0] == 'wl_file_already_exists') or (status[0] == 'bl_file_already_exists') %}
        A file with that name already exists. The {{ list|lower }} was not exported
      {% elif (status[0] == 'wl_dropped') or (status[0] == 'bl_dropped') %}
        {{ list }} dropped
      {% elif status[0] == 'invalid_path_format' %}
        Invalid path format!
      {% elif status[0] == 'invalid_path' %}
        Invalid path!
      {% endif %}
      {% if (status[0] != 'default') %}
        <br /><br /><a href="/admin"><span class="glyphicon glyphicon-remove"></span> close</a>
      {% endif %}
    </div>
  </div>
  <div id='stats' class="well well-small">
    <div>
      <span>Database info for database <b>{{stats['dbName']}}</b></span>
      <table class="table table-hover table-striped table-nonfluid table-condensed">
        <thead>
          <tr class="warning"><td>Collection</td><td>#records</td><td>Last update</td></tr>
        </thead>
        <tr><td>CVES</td>             <td>{{stats['cveA']}}</td>
            <td>{% if stats['cveU'] is not none %}{{stats['cveU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
        <tr><td>CPE</td>              <td>{{stats['cpeA']}}</td>
            <td>{% if stats['cpeU'] is not none %}{{stats['cpeU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
        <tr><td>CPE-other</td>        <td>{{stats['cpeOtherA']}}</td>
            <td>{% if stats['cpeOtherU'] is not none %}{{stats['cpeOtherU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
        <tr><td>Capec</td>            <td>{{stats['capecA']}}</td>
            <td>{% if stats['capecU'] is not none %}{{stats['capecU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
        <tr><td>d2sec</td>            <td>{{stats['d2secA']}}</td>
            <td>{% if stats['d2secU'] is not none %}{{stats['d2secU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
        <tr><td>Vendor statements</td><td>{{stats['vendorA']}}</td>
            <td>{% if stats['vendorU'] is not none %}{{stats['vendorU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
        <tr><td>vFeed info</td>       <td>{{stats['vfeedA']}}</td>
            <td>{% if stats['vfeedU'] is not none %}{{stats['vfeedU']|currentTime}} {% else %}Not updated{% endif %}</td><tr>
      </table>
      <span>Whitelist: {{stats['wlA']}} rules</span><br />
      <span>Blacklist: {{stats['blA']}} rules</span><br /><br />
      <span>Database size: {{'%0.2f' % (stats['dbSize']/1024**2)}}MB ({{'%0.2f' % (stats['dbSize']/1024**3)}}GB)</span><br />
      <span>Database size on disk: {{'%0.2f' % (stats['dbOnDisk']/1024**2)}}MB ({{'%0.2f' % (stats['dbOnDisk']/1024**3)}}GB)</span>
    </div>
  </div>
  <!-- Database update -->
  <div class="well well-small tab">
    <form action="/admin/updatedb">
      <strong>Update the database</strong> <br />
      <input type="submit" value="Update"/>
    </form>
  </div>
  <!-- Whitelist import -->
  <div class="well well-small tab">
    <strong>Manage whitelist</strong> <br />
    <input id="wl_Import" type='file' name='file' /> <br />
    <input type="checkbox" id="wl_ForceImport">Force<br />
    <button onclick="whitelistImport()">Import</button>
    <button onclick="whitelistExport()">Export</button>
    <button onclick="dropWhitelist()">Drop list</button>
    <button onclick="location.href='/admin/whitelist'">View</button>
  </div>
  <!-- Blacklist import -->
  <div class="well well-small tab">
    <strong>Manage blacklist</strong> <br />
    <input id="bl_Import" type='file' name='file' /> <br />
    <input type="checkbox" id="bl_ForceImport">Force<br />
    <button onclick="blacklistImport()">Import</button>
    <button onclick="blacklistExport()">Export</button>
    <button onclick="dropBlacklist()">Drop list</button>
    <button onclick="location.href='/admin/blacklist'">View</button>
  </div>
  <a href="#" class="back-to-top">Back to Top</a>
{% endblock %}
